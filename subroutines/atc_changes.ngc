O<atc_changes> SUB

;pretool change


M65 P4  ;stop spindle
M65 P5  ;stop coolant flood
M65 P6  ;stop coolant mist
(DEBUG, milling stopped and tool change arm is safe to move)


M65 P0     ;retract tc arm off ONLY WHEN IT NEEDS TO BE EXTENDED IS THIS THING OFF
M64 P2     ;extend tc arm on

;making sure the arm is full extended:

M66 P3 L3 Q2    ;checking for extend proximity pin to go high
; program will continue to wait until extended P3 to go high
O101 while [#5399 EQ -1]
M66 P3 L3 Q1  ;  for input with the machine, goes low when arm if fully extended  ;
(DEBUG, IN LOOP print #5399)
O101 endwhile
(DEBUG,  loop exited arm is fully extended #5399 = 1.0000)
;toolchange with the carousel components! 

(DEBUG, program paused, click resume )
M0   ;PAUSE for safety, until the prox signals work properly


;tool change is complete 
;post-tool change:

;arm can now be retracted
M65 P2     ;extend tc arm off
M64 P0     ;retract tc arm on

;checking for arm to be fully retracted:
M66 P1 L3 Q2  ;  waiting on input from retract_prox signal to go high, which means it is in the correct position
O11 while [#5399 LT 0]
M66 P1 L3 Q2  ;  waiting on input from retract_prox signal to go high, which means it is in the correct position
(DEBUG, check if fully retracted, 5399 = #5399)
O11 endwhile

(DEBUG, out of loop if retracted fully 1.00 = #5399)
(DEBUG, click play to resume spindle and other machine movements)
M0


M64 P4  ;start spindle
M64 P5  ;start coolant flood
M64 P6  ;start coolant mist

O<atc_changes> ENDSUB [1]

